<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>do a dither!</title>
</head>
<body>
    <h1>do a dither!</h1>
    <p>one-bit Floyd-Steinberg dither in your browser! <br> forked with permission from <a href="https://eli.li/_assets/bin/dither/index.htm">eli oat</a> &lt;3.</p>
    <p>(optional) input colours, to replace black and white</p>
    <p>note: for now you need to reupload the image file each time you change colours.</p>
    <label for="input">colour 0:</label>
    <input type="color" id="colour0" value="#ffffff">
    <br>
    <label for="input">colour 1:</label>
    <input type="color" id="colour1" value="#000000">
    <br>
    <button id="invert">invert colours</button>
    <!-- maybe make it fancy like the input colours style the page -->
    <br>
    <label for="canvas">result:</label>
    <br>
    <canvas id="canvas"></canvas>
    <br><br>
    <!-- <h2>Step 1.</h2> -->
    <label for="upload">Upload an image:</label>
    <br>
    <input type="file" id="upload" accept="image/*">
    <br>
    <!-- <h2>Step 2.</h2> -->
    <label for="download">Download the image:</label>
    <br>
    <button id="download">download</button>
    <!-- <h2>image data</h2> -->
    <br>
    <label for="copy">...or copy the image data:</label>
    <br>
    <button id="copy">copy</button>
    <!-- <p><code id="dataurl"></code></p> -->

    <style>
        :root {
            --colour1: black;
            --colour0: white;
        }
        body {
            font-family: Courier, monospace;
            padding: 0.25em 0.5em;
            background-color: var(--colour1);
            color: var(--colour0);
            line-height: 2em;
            /* display: block; */
            /* font-size: large; */
        }
        label {
            font-size: 0.9em;
        }
        canvas, input, button {
            max-width: calc(100% - 4em);
            padding: 0;
            border: 1px solid var(--colour0);
            box-sizing: border-box;
        }
        button, input[type="file"] {
            font-family: Courier, monospace;
            border-radius: 7px;
            cursor: pointer;
            padding: 1em 1em 1em 1em;
            font-size: 1.25em;
            margin: 0 0 1em 0;
            background-color: var(--colour1);
            color: var(--colour0);
            font-size: 0.9em;
        }
        a {
            color: var(--colour0);
            text-decoration-style: dotted;
        }
        code {
            max-width: 4em;
        }
        input[type="file"] {
            background-color: var(--colour1);
            color: var(--colour0);
        }
    </style>
    <script>
        // forked from https://eli.li/_assets/bin/dither/dither.js
        //custom colours added by Olive :]
        // TODO: colour lookup and replace function
        // TODO: set default colours in one place and propogate.
        const upload = document.getElementById('upload');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        var dataUrl = "beep boop";
        // var coloursRGB = [[0,0,0], [255,255,255]];
        var coloursRGB = [[255,255,255], [0,0,0]];
        const root = document.querySelector(':root');

        
        const colourInputs = document.querySelectorAll('input[type=color]');
        // console.log(colourInputs);

        // colourInputs[0].addEventListener('change', function() {
        //     updateColours(0, event.target.value)});

        for(let i = 0; i < colourInputs.length; i++){
            setImageColours(i, hexToRGB(colourInputs[i].value));
            colourInputs[i].addEventListener('change', function() {    
                setImageColours(i, hexToRGB(event.target.value));
            });
            colourInputs[i].addEventListener('input', function() {
                setStyleColours(i, event.target.value)});
            }
        
        function setImageColours(index, value){
            // console.log(`ImageColours ${index}, ${value}`);
            coloursRGB[index] = (value);
        }

        function setStyleColours(index, value){
            root.style.setProperty(`--colour${index.toString()}`, value);
        }

        //invert colours
        document.getElementById('invert').addEventListener('click', function() {
            let temp = colourInputs[0].value;
            colourInputs[0].value = colourInputs[1].value;
            colourInputs[1].value = temp;

            temp = coloursRGB[0];
            setImageColours(0, coloursRGB[1]);
            setImageColours(1, temp);

            setStyleColours(0, colourInputs[0].value);
            setStyleColours(1, colourInputs[1].value);
        });

        function hexToRGB(hex) {
            var rgb = [0,0,0];
            var hex = hex.replace("#", "");
            rgb[0] = parseInt(hex.substring(0, 2), 16);
            rgb[1] = parseInt(hex.substring(2, 4), 16);
            rgb[2] = parseInt(hex.substring(4, 6), 16);
            return rgb;
        }

        upload.addEventListener('change', function (e) {
            const file = e.target.files[0];
            const reader = new FileReader();
            reader.onload = function (event) {
                const img = new Image();
                img.onload = function () {
                    canvas.width = img.width;
                    canvas.height = img.height;
                    ctx.drawImage(img, 0, 0);
                    applyDithering();
                };
                img.src = event.target.result;
            };
            reader.readAsDataURL(file);
        });

        // TIL how to do this!
        document.getElementById('download').addEventListener('click', function() {
            dataUrl = canvas.toDataURL('image/png'); // Convert the canvas to a data URL
            const a = document.createElement('a'); // Create an anchor element
            a.href = dataUrl; // Set the href of the anchor to the data URL
            a.download = 'dithered-image.png'; // Set the download attribute to the desired file name
            a.setAttribute('rel', 'noopener noreferrer');
            a.setAttribute('target', '_blank');
            document.body.appendChild(a); // Append the anchor to the body
            a.click(); // Trigger a click on the anchor to start the download
            document.body.removeChild(a); // Remove the anchor from the body
        });

        //first javascript I've worked on in a year :D -Olive
        document.getElementById('copy').addEventListener('click', function() {
            dataUrl = canvas.toDataURL('image/png');
            var copyText = document.createElement("textarea");
            copyText.value = dataUrl;
            document.body.append(copyText)
            copyText.select();
            copyText.setSelectionRange(0, 99999)
            document.execCommand("copy");
            copyText.remove()
            // document.getElementById("dataurl").innerHTML = dataUrl;
            console.log(dataUrl)
            // navigator.clipboard.writeText(dataUrl.value);
        });

        function applyDithering() {
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            var data = imageData.data;
            const width = canvas.width;
            const height = canvas.height;

            // Find the gray value of a pixel
            const getGrayValue = (r, g, b) => 0.299 * r + 0.587 * g + 0.114 * b;

            // Set the pixel value
            const setPixel = (x, y, value) => {
                const i = (y * width + x) * 4;
                const j = value < 128 ? 0 : 1;
                data[i] = coloursRGB[j][0];
                data[i + 1] = coloursRGB[j][1];
                data[i + 2] = coloursRGB[j][2];
                data[i + 3] = 255;
                // data[i, i + 1, i + 2, i + 3] = coloursRGB[[j][0], [j][1], [j][2], 255];
            };

            // https://en.wikipedia.org/wiki/Floydâ€“Steinberg_dithering

            // Loop through each pixel in the image
            for (let y = 0; y < height; y++) {
                for (let x = 0; x < width; x++) {
                    const index = (y * width + x) * 4;
                    const oldR = data[index];
                    const oldG = data[index + 1];
                    const oldB = data[index + 2];
                    const oldGray = getGrayValue(oldR, oldG, oldB);
                    const newGray = oldGray < 128 ? 0 : 255;
                    const error = oldGray - newGray;

                    setPixel(x, y, oldGray);

                    // Spread error to neighboring pixels
                    if (x + 1 < width) {
                        data[(y * width + x + 1) * 4] += error * 7 / 16;
                        data[(y * width + x + 1) * 4 + 1] += error * 7 / 16;
                        data[(y * width + x + 1) * 4 + 2] += error * 7 / 16;
                    }
                    if (y + 1 < height) {
                        if (x - 1 >= 0) {
                            data[((y + 1) * width + x - 1) * 4] += error * 3 / 16;
                            data[((y + 1) * width + x - 1) * 4 + 1] += error * 3 / 16;
                            data[((y + 1) * width + x - 1) * 4 + 2] += error * 3 / 16;
                        }
                        data[((y + 1) * width + x) * 4] += error * 5 / 16;
                        data[((y + 1) * width + x) * 4 + 1] += error * 5 / 16;
                        data[((y + 1) * width + x) * 4 + 2] += error * 5 / 16;
                        if (x + 1 < width) {
                            data[((y + 1) * width + x + 1) * 4] += error * 1 / 16;
                            data[((y + 1) * width + x + 1) * 4 + 1] += error * 1 / 16;
                            data[((y + 1) * width + x + 1) * 4 + 2] += error * 1 / 16;
                        }
                    }
                }
            }

            ctx.putImageData(imageData, 0, 0);
        }
    </script>
</body>
</html>
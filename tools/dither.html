<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>do a dither!</title>
</head>
<body>
    <h1>do a dither!</h1>
    <p>one-bit Floyd-Steinberg dither in your browser! <br> forked with permission from <a href="https://eli.li/_assets/bin/dither/index.htm">eli oat</a> &lt;3.</p>
    <p>todo: add input colours</p>
    <!-- maybe make it fancy like the input colours style the page -->
    <canvas id="canvas"></canvas>
    <br>
    <!-- <h2>Step 1.</h2> -->
    <label for="upload">Upload an image:</label>
    <br>
    <input type="file" id="upload" accept="image/*">
    <br>
    <!-- <h2>Step 2.</h2> -->
    <label for="download">Download the image:</label>
    <br>
    <button id="download">download</button>
    <!-- <h2>image data</h2> -->
    <br>
    <label for="copy">...or copy the image data:</label>
    <br>
    <button id="copy">copy</button>
    <!-- <p><code id="dataurl"></code></p> -->

    <style>
        body {
            font-family: monospace;
            padding: 0.25em 0.5em;
            background-color: white;
            color: black;
            line-height: 2em;
            /* display: block; */
            /* font-size: large; */
        }
        label {
            font-size: 1.25em;
        }
        canvas, input, button {
            max-width: calc(100% - 4em);
            padding: 0;
            border: 1px solid black;
            box-sizing: border-box;
        }
        button, input[type="file"] {
            border-radius: 7px;
            cursor: pointer;
            padding: 1em 1em 1em 1em;
            font-size: 1.25em;
            margin: 0 0 1em 0;
        }
        a {
            color: black;
        }
        code {
            max-width: 4em;
        }
    </style>
    <script>
        // forked from https://eli.li/_assets/bin/dither/dither.js

        const upload = document.getElementById('upload');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        let dataUrl = "beep boop";

        upload.addEventListener('change', function (e) {
            const file = e.target.files[0];
            const reader = new FileReader();
            reader.onload = function (event) {
                const img = new Image();
                img.onload = function () {
                    canvas.width = img.width;
                    canvas.height = img.height;
                    ctx.drawImage(img, 0, 0);
                    applyDithering();
                };
                img.src = event.target.result;
            };
            reader.readAsDataURL(file);
        });

        // TIL how to do this!
        document.getElementById('download').addEventListener('click', function() {
            dataUrl = canvas.toDataURL('image/png'); // Convert the canvas to a data URL
            const a = document.createElement('a'); // Create an anchor element
            a.href = dataUrl; // Set the href of the anchor to the data URL
            a.download = 'dithered-image.png'; // Set the download attribute to the desired file name
            a.setAttribute('rel', 'noopener noreferrer');
            a.setAttribute('target', '_blank');
            document.body.appendChild(a); // Append the anchor to the body
            a.click(); // Trigger a click on the anchor to start the download
            document.body.removeChild(a); // Remove the anchor from the body
        });

        //first javascript I've written in a year :D -Olive
        document.getElementById('copy').addEventListener('click', function() {
            dataUrl = canvas.toDataURL('image/png');
            var copyText = document.createElement("textarea");
            copyText.value = dataUrl;
            document.body.append(copyText)
            copyText.select();
            copyText.setSelectionRange(0, 99999)
            document.execCommand("copy");
            copyText.remove()
            // document.getElementById("dataurl").innerHTML = dataUrl;
            // console.log(dataUrl)
            // navigator.clipboard.writeText(dataUrl.value);
        });

        function applyDithering() {
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            const width = canvas.width;
            const height = canvas.height;

            // Find the gray value of a pixel
            const getGrayValue = (r, g, b) => 0.299 * r + 0.587 * g + 0.114 * b;

            // Set the pixel value
            const setPixel = (x, y, value) => {
                const index = (y * width + x) * 4;
                const gray = value < 128 ? 0 : 255;
                data[index] = gray;
                data[index + 1] = gray;
                data[index + 2] = gray;
                data[index + 3] = 255;
            };

            // https://en.wikipedia.org/wiki/Floydâ€“Steinberg_dithering

            // Loop through each pixel in the image
            for (let y = 0; y < height; y++) {
                for (let x = 0; x < width; x++) {
                    const index = (y * width + x) * 4;
                    const oldR = data[index];
                    const oldG = data[index + 1];
                    const oldB = data[index + 2];
                    const oldGray = getGrayValue(oldR, oldG, oldB);
                    const newGray = oldGray < 128 ? 0 : 255;
                    const error = oldGray - newGray;

                    setPixel(x, y, oldGray);

                    // Spread error to neighboring pixels
                    if (x + 1 < width) {
                        data[(y * width + x + 1) * 4] += error * 7 / 16;
                        data[(y * width + x + 1) * 4 + 1] += error * 7 / 16;
                        data[(y * width + x + 1) * 4 + 2] += error * 7 / 16;
                    }
                    if (y + 1 < height) {
                        if (x - 1 >= 0) {
                            data[((y + 1) * width + x - 1) * 4] += error * 3 / 16;
                            data[((y + 1) * width + x - 1) * 4 + 1] += error * 3 / 16;
                            data[((y + 1) * width + x - 1) * 4 + 2] += error * 3 / 16;
                        }
                        data[((y + 1) * width + x) * 4] += error * 5 / 16;
                        data[((y + 1) * width + x) * 4 + 1] += error * 5 / 16;
                        data[((y + 1) * width + x) * 4 + 2] += error * 5 / 16;
                        if (x + 1 < width) {
                            data[((y + 1) * width + x + 1) * 4] += error * 1 / 16;
                            data[((y + 1) * width + x + 1) * 4 + 1] += error * 1 / 16;
                            data[((y + 1) * width + x + 1) * 4 + 2] += error * 1 / 16;
                        }
                    }
                }
            }

            ctx.putImageData(imageData, 0, 0);
        }
    </script>
</body>
</html>